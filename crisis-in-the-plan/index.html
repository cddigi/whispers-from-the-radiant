<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=no"
        />
        <title>Whispers of Foundation - A Second Foundation Duel</title>

        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                user-select: none;
                -webkit-user-select: none;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: radial-gradient(
                    ellipse at center,
                    #1a0033 0%,
                    #000000 100%
                );
                color: #e0e0e0;
                height: 100vh;
                overflow: hidden;
                position: relative;
            }

            /* Prime Radiant background effect */
            body::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-image:
                    repeating-linear-gradient(
                        0deg,
                        transparent,
                        transparent 2px,
                        rgba(138, 43, 226, 0.03) 2px,
                        rgba(138, 43, 226, 0.03) 4px
                    ),
                    repeating-linear-gradient(
                        90deg,
                        transparent,
                        transparent 2px,
                        rgba(138, 43, 226, 0.03) 2px,
                        rgba(138, 43, 226, 0.03) 4px
                    );
                animation: radiant-drift 30s linear infinite;
                pointer-events: none;
            }

            @keyframes radiant-drift {
                0% {
                    transform: translate(0, 0) rotate(0deg);
                }
                100% {
                    transform: translate(30px, 30px) rotate(1deg);
                }
            }

            .game-container {
                width: 100vw;
                height: 100vh;
                display: flex;
                flex-direction: column;
                position: relative;
            }

            /* Player areas - side by side layout */
            .player-area {
                flex: 1;
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                position: relative;
                padding: 20px;
                gap: 30px;
            }

            .player-area.opponent {
                /* Player 2 at top - don't rotate entire area, rotate components individually */
            }
            
            /* Rotate Player 2's hand 180 degrees */
            .player-area.opponent .hand {
                transform: rotate(180deg);
            }
            
            /* Rotate Player 2's player-info board 180 degrees */
            .player-area.opponent .player-info {
                transform: rotate(180deg);
            }

            /* Info panel */
            .info-panel {
                position: absolute;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(26, 0, 51, 0.9);
                padding: 12px 24px;
                border-radius: 12px;
                border: 2px solid rgba(138, 43, 226, 0.5);
                text-align: center;
                z-index: 100;
                box-shadow: 0 0 20px rgba(138, 43, 226, 0.3);
            }

            .info-panel h3 {
                color: #daa520;
                font-size: 14px;
                margin-bottom: 5px;
            }

            .info-panel .details {
                font-size: 12px;
                color: #9b7dff;
            }

            /* Hand container */
            .hand {
                display: flex;
                gap: 12px;
                padding: 20px;
                border-radius: 15px;
                background: rgba(26, 0, 51, 0.6);
                border: 2px solid rgba(138, 43, 226, 0.3);
                min-height: 140px;
                align-items: center;
                justify-content: center;
                flex-wrap: wrap;
                max-width: 90vw;
                position: relative;
                transition: all 0.3s ease;
            }

            .hand.revealing {
                box-shadow: 0 0 30px rgba(138, 43, 226, 0.5);
                border-color: rgba(138, 43, 226, 0.7);
            }

            /* Card styles */
            .card {
                width: 70px;
                height: 100px;
                border-radius: 10px;
                position: relative;
                transition: all 0.3s ease;
                cursor: pointer;
                transform-style: preserve-3d;
                border: 2px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }

            .card:hover:not(.concealed) {
                transform: translateY(-10px) scale(1.05);
                box-shadow: 0 15px 30px rgba(138, 43, 226, 0.5);
            }

            .card.playable {
                border: 2px solid #ffd700;
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
                background: linear-gradient(to bottom, 
                    rgba(255, 215, 0, 0.1), 
                    rgba(255, 215, 0, 0.05));
            }

            .card.selectable {
                border: 3px solid #daa520;
                animation: selection-pulse 1s ease-in-out infinite;
            }


            @keyframes selection-pulse {
                0%,
                100% {
                    transform: scale(1);
                    box-shadow: 0 0 10px rgba(218, 165, 32, 0.5);
                }
                50% {
                    transform: scale(1.05);
                    box-shadow: 0 0 20px rgba(218, 165, 32, 0.8);
                }
            }

            /* Card face */
            .card-face {
                width: 100%;
                height: 100%;
                border-radius: 8px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                font-weight: bold;
                position: relative;
                overflow: hidden;
                padding: 8px;
            }

            /* Mental shield (concealment) */
            .card.concealed .card-face {
                background: linear-gradient(135deg, #2a0845, #1a0033);
            }

            .card.concealed .card-content {
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .card.concealed::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: 
                    repeating-linear-gradient(
                        45deg,
                        transparent,
                        transparent 3px,
                        rgba(138, 43, 226, 0.15) 3px,
                        rgba(138, 43, 226, 0.15) 6px
                    ),
                    repeating-linear-gradient(
                        -45deg,
                        transparent,
                        transparent 2px,
                        rgba(255, 100, 150, 0.1) 2px,
                        rgba(255, 100, 150, 0.1) 4px
                    );
                animation: mental-static 3s linear infinite;
                border-radius: 8px;
                z-index: 2;
            }

            .card.concealed::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: radial-gradient(
                    circle at 30% 40%,
                    rgba(138, 43, 226, 0.2),
                    transparent 60%
                ),
                radial-gradient(
                    circle at 70% 60%,
                    rgba(255, 100, 150, 0.15),
                    transparent 50%
                );
                animation: shield-pulse 2s ease-in-out infinite;
                border-radius: 8px;
                z-index: 3;
            }

            @keyframes mental-static {
                0% {
                    transform: translate(0, 0) scale(1);
                    opacity: 0.7;
                }
                33% {
                    transform: translate(2px, -1px) scale(1.01);
                    opacity: 0.9;
                }
                66% {
                    transform: translate(-1px, 2px) scale(0.99);
                    opacity: 0.6;
                }
                100% {
                    transform: translate(0, 0) scale(1);
                    opacity: 0.7;
                }
            }

            @keyframes shield-pulse {
                0%, 100% {
                    opacity: 0.3;
                    transform: scale(1);
                }
                50% {
                    opacity: 0.8;
                    transform: scale(1.03);
                }
            }

            /* Psychohistorical equations overlay */
            .equations-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                font-size: 7px;
                color: rgba(138, 43, 226, 0.4);
                overflow: hidden;
                z-index: 3;
                font-family: "Courier New", monospace;
                pointer-events: none;
            }

            .equation-line {
                position: absolute;
                white-space: nowrap;
                opacity: 0.6;
                animation: equation-flow 12s linear infinite;
            }

            .equation-line:nth-child(even) {
                animation-direction: reverse;
                opacity: 0.4;
            }

            .equation-line:nth-child(3n) {
                animation-duration: 18s;
                color: rgba(255, 100, 150, 0.5);
            }

            @keyframes equation-flow {
                0% {
                    transform: translateX(-120%);
                    opacity: 0;
                }
                10% {
                    opacity: 0.6;
                }
                90% {
                    opacity: 0.6;
                }
                100% {
                    transform: translateX(120%);
                    opacity: 0;
                }
            }

            /* Suit colors */
            .mental {
                background: linear-gradient(135deg, #4169e1, #1e3a8a);
            }
            .physical {
                background: linear-gradient(135deg, #ffd700, #b8860b);
            }
            .temporal {
                background: linear-gradient(135deg, #dc143c, #8b0000);
            }

            /* Card content */
            .card-value {
                font-size: 32px;
                font-weight: bold;
                color: white;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            }

            .card-suit {
                font-size: 20px;
                margin-top: 4px;
            }

            .ability-name {
                font-size: 8px;
                color: rgba(255, 255, 255, 0.8);
                margin-top: 4px;
                text-align: center;
            }

            /* Prime Radiant (decree card) */
            .prime-radiant {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                width: 120px;
                height: 160px;
                background: linear-gradient(135deg, #4a0080, #2a0050);
                border: 3px solid #daa520;
                border-radius: 12px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                box-shadow: 0 0 40px rgba(218, 165, 32, 0.6);
                animation: radiant-pulse 3s ease-in-out infinite;
                padding: 10px;
                z-index: 10;
            }

            @keyframes radiant-pulse {
                0%,
                100% {
                    box-shadow: 0 0 30px rgba(218, 165, 32, 0.4);
                }
                50% {
                    box-shadow: 0 0 50px rgba(218, 165, 32, 0.8);
                }
            }

            .prime-radiant .label {
                font-size: 11px;
                color: #daa520;
                margin-bottom: 8px;
                font-weight: bold;
                text-align: center;
            }

            .dominant-aspect {
                position: absolute;
                bottom: 8px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                padding: 4px 8px;
                border-radius: 6px;
                border: 1px solid #daa520;
                font-size: 10px;
                color: #daa520;
                text-align: center;
                min-width: 70px;
            }

            .aspect-symbol {
                font-size: 16px;
                display: block;
                margin-bottom: 2px;
            }

            /* Playing field */
            .play-field {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                display: flex;
                gap: 40px;
                padding: 30px;
                background: radial-gradient(
                    ellipse at center,
                    rgba(138, 43, 226, 0.2),
                    transparent
                );
                border-radius: 20px;
                border: 2px solid rgba(138, 43, 226, 0.3);
                min-width: 320px;
                min-height: 160px;
                align-items: center;
                justify-content: center;
                box-shadow: inset 0 0 30px rgba(138, 43, 226, 0.2);
            }

            /* Score display - now part of combined info */
            .score-display {
                background: rgba(26, 0, 51, 0.9);
                padding: 12px 18px;
                border-radius: 12px;
                border: 2px solid rgba(138, 43, 226, 0.5);
                font-size: 13px;
                min-width: 120px;
                flex-shrink: 0;
            }

            .score-display h4 {
                color: #daa520;
                margin-bottom: 8px;
                text-align: center;
            }

            .score-display .score-line {
                display: flex;
                justify-content: space-between;
                margin: 4px 0;
                color: #9b7dff;
                gap: 15px;
            }

            /* Reveal button */
            .reveal-btn {
                padding: 12px 24px;
                background: linear-gradient(135deg, #6b46c1, #4a0080);
                border: 2px solid rgba(138, 43, 226, 0.7);
                border-radius: 25px;
                color: white;
                font-weight: bold;
                cursor: pointer;
                margin: 12px;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4);
            }

            .reveal-btn:active,
            .reveal-btn.active {
                transform: scale(0.95);
                background: linear-gradient(135deg, #8b5cf6, #6b46c1);
                box-shadow: 0 2px 8px rgba(138, 43, 226, 0.6);
            }

            .reveal-btn.ai-player {
                background: linear-gradient(135deg, #444, #222);
                border-color: rgba(100, 100, 100, 0.7);
                cursor: default;
            }

            /* Start screen */
            .start-screen {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: radial-gradient(
                    ellipse at center,
                    #1a0033 0%,
                    #000000 100%
                );
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                padding: 20px;
            }

            .start-screen h1 {
                font-size: 56px;
                margin-bottom: 12px;
                color: #daa520;
                text-shadow: 0 0 30px rgba(218, 165, 32, 0.5);
            }

            .start-screen .subtitle {
                font-size: 20px;
                color: #9b7dff;
                margin-bottom: 30px;
            }

            .start-screen .description {
                color: #888;
                margin-bottom: 30px;
                text-align: center;
                max-width: 700px;
                line-height: 1.6;
            }

            .game-mode-buttons {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
            }

            .mode-btn {
                padding: 15px 30px;
                font-size: 18px;
                background: linear-gradient(135deg, #6b46c1, #4a0080);
                border: 2px solid #daa520;
                border-radius: 25px;
                color: white;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .mode-btn:hover {
                transform: scale(1.05);
                box-shadow: 0 0 25px rgba(218, 165, 32, 0.5);
            }

            /* Victory screen */
            .victory-screen {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: radial-gradient(
                    ellipse at center,
                    #1a0033 0%,
                    #000000 100%
                );
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }

            .victory-screen h2 {
                font-size: 48px;
                color: #daa520;
                margin-bottom: 20px;
                text-shadow: 0 0 30px rgba(218, 165, 32, 0.8);
            }

            .victory-screen .final-scores {
                font-size: 20px;
                color: #9b7dff;
                margin-bottom: 30px;
                text-align: center;
            }

            .new-game-btn {
                padding: 15px 40px;
                font-size: 20px;
                background: linear-gradient(135deg, #6b46c1, #4a0080);
                border: 3px solid #daa520;
                border-radius: 30px;
                color: white;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .new-game-btn:hover {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(218, 165, 32, 0.6);
            }

            .player-switch {
                position: absolute;
                top: 10px;
                right: 10px;
                z-index: 101;
            }

            .player-switch button {
                padding: 8px 16px;
                background: #1a0033;
                color: #daa520;
                border: 2px solid #6b46c1;
                border-radius: 8px;
                cursor: pointer;
                font-weight: bold;
            }

            .player-switch button:hover {
                background: #2a0050;
            }

            /* Selection modal */
            .selection-modal {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(26, 0, 51, 0.95);
                padding: 30px;
                border-radius: 20px;
                border: 3px solid #daa520;
                z-index: 200;
                box-shadow: 0 0 50px rgba(218, 165, 32, 0.5);
            }

            .selection-modal h3 {
                color: #daa520;
                margin-bottom: 20px;
                text-align: center;
            }

            .selection-cards {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
            }

            .selection-modal .instruction {
                color: #9b7dff;
                text-align: center;
                margin-bottom: 10px;
            }

            .ai-thinking {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(26, 0, 51, 0.9);
                padding: 20px 40px;
                border-radius: 15px;
                border: 2px solid #daa520;
                color: #daa520;
                font-size: 18px;
                z-index: 150;
                animation: thinking-pulse 1.5s ease-in-out infinite;
            }

            @keyframes thinking-pulse {
                0%,
                100% {
                    opacity: 0.8;
                }
                50% {
                    opacity: 1;
                }
            }

            /* Combined player info panels */
            .player-info {
                display: flex;
                gap: 20px;
                align-items: flex-start;
                flex-wrap: wrap;
                flex-shrink: 0;
            }

            .player-info.player2 {
                /* Player 2's board should be rotated 180 degrees independently */
                transform: rotate(180deg);
            }

            /* Player-specific compact legends - now part of combined info */
            .player-legend {
                width: 250px;
                background: rgba(26, 0, 51, 0.95);
                border: 2px solid rgba(138, 43, 226, 0.7);
                border-radius: 12px;
                padding: 12px;
                font-size: 11px;
                color: #9b7dff;
                flex-shrink: 0;
            }

            .legend-title {
                color: #daa520;
                margin-bottom: 10px;
                text-align: center;
                font-size: 12px;
                font-weight: bold;
            }

            /* Character Abilities Styling */
            .character-ability {
                background: rgba(75, 0, 130, 0.3);
                border: 1px solid rgba(138, 43, 226, 0.6);
                border-radius: 8px;
                padding: 8px;
                margin-bottom: 10px;
            }

            .ability-header {
                display: flex;
                align-items: center;
                gap: 6px;
                margin-bottom: 4px;
            }

            .ability-icon {
                font-size: 14px;
                flex-shrink: 0;
            }

            .ability-name {
                color: #ffd700;
                font-size: 10px;
                font-weight: bold;
                flex-grow: 1;
            }

            .ability-description {
                color: #b8860b;
                font-size: 8px;
                line-height: 1.2;
                font-style: italic;
            }

            .abilities-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
                margin-bottom: 12px;
            }

            .ability-item {
                display: flex;
                align-items: center;
                padding: 4px;
                background: rgba(138, 43, 226, 0.15);
                border-radius: 4px;
            }

            .ability-num {
                width: 16px;
                height: 16px;
                border-radius: 3px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 10px;
                color: white;
                margin-right: 6px;
                flex-shrink: 0;
            }

            .ability-num.special-1 { background: #4169e1; }
            .ability-num.special-3 { background: #ffd700; color: #000; }
            .ability-num.special-5 { background: #dc143c; }
            .ability-num.special-7 { background: #32cd32; color: #000; }
            .ability-num.special-9 { background: #ff69b4; }
            .ability-num.special-11 { background: #ff8c00; }

            .ability-text {
                font-size: 8px;
                line-height: 1.2;
            }

            .scoring-table {
                margin-top: 8px;
            }

            .scoring-title {
                color: #daa520;
                font-size: 10px;
                font-weight: bold;
                margin-bottom: 6px;
                text-align: center;
            }

            .score-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 2px 6px;
                margin: 1px 0;
                border-radius: 3px;
                font-size: 8px;
            }

            .score-row.current-p1 {
                background: rgba(65, 105, 225, 0.3);
                border: 1px solid #4169e1;
            }

            .score-row.current-p2 {
                background: rgba(220, 20, 60, 0.3);
                border: 1px solid #dc143c;
            }

            .tricks-count {
                font-weight: bold;
                min-width: 20px;
            }

            .points-award {
                color: #32cd32;
                font-weight: bold;
            }

            /* Treasure tracker - now part of combined info, split per player */
            .treasure-tracker {
                width: 150px;
                background: rgba(26, 0, 51, 0.9);
                border: 2px solid rgba(138, 43, 226, 0.5);
                border-radius: 12px;
                padding: 12px;
                flex-shrink: 0;
            }

            /* Prime Radiant component for player boards */
            .prime-radiant-board {
                width: 120px;
                background: linear-gradient(135deg, #4a0080, #2a0050);
                border: 3px solid #daa520;
                border-radius: 12px;
                padding: 10px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                box-shadow: 0 0 40px rgba(218, 165, 32, 0.6);
                animation: radiant-pulse 3s ease-in-out infinite;
                flex-shrink: 0;
            }

            .prime-radiant-board .label {
                font-size: 10px;
                color: #daa520;
                margin-bottom: 8px;
                font-weight: bold;
                text-align: center;
            }

            .prime-radiant-board .dominant-aspect {
                background: rgba(0, 0, 0, 0.8);
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 8px;
                color: #daa520;
                text-align: center;
                margin-top: 8px;
            }

            .prime-radiant-board .aspect-symbol {
                margin-right: 4px;
            }

            /* Cards played history display */
            .cards-history {
                position: fixed;
                top: 10px;
                right: 10px;
                width: 200px;
                max-height: 300px;
                background: rgba(26, 0, 51, 0.95);
                border: 2px solid rgba(138, 43, 226, 0.7);
                border-radius: 8px;
                padding: 10px;
                font-family: monospace;
                font-size: 11px;
                color: #9b7dff;
                overflow-y: auto;
                z-index: 100;
            }

            .cards-history h4 {
                color: #daa520;
                margin: 0 0 8px 0;
                font-size: 12px;
                text-align: center;
            }

            .history-entry {
                margin: 2px 0;
                font-size: 10px;
            }

            .history-trick {
                color: #ffd700;
                margin-top: 6px;
                border-top: 1px solid rgba(138, 43, 226, 0.3);
                padding-top: 2px;
            }


            .treasure-tracker h4 {
                color: #daa520;
                margin-bottom: 15px;
                text-align: center;
                font-size: 13px;
            }

            .treasure-suit {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 10px;
                padding: 8px;
                background: rgba(138, 43, 226, 0.1);
                border-radius: 6px;
            }

            .treasure-suit .suit-info {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .treasure-suit .suit-symbol {
                font-size: 16px;
            }

            .treasure-suit .suit-name {
                font-size: 11px;
                color: #9b7dff;
            }

            .treasure-indicator {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                border: 2px solid #666;
                transition: all 0.3s ease;
            }

            .treasure-indicator.player1 {
                background: #4169e1;
                border-color: #4169e1;
            }

            .treasure-indicator.player2 {
                background: #dc143c;
                border-color: #dc143c;
            }

            /* Game controls */
            .game-controls {
                position: absolute;
                top: 10px;
                right: 10px;
                display: flex;
                gap: 10px;
                z-index: 200;
            }

            .control-btn {
                padding: 8px 16px;
                background: linear-gradient(135deg, #6b46c1, #4a0080);
                border: 2px solid #daa520;
                border-radius: 20px;
                color: white;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .control-btn:hover {
                background: linear-gradient(135deg, #8b5cf6, #6b46c1);
                box-shadow: 0 2px 8px rgba(218, 165, 32, 0.3);
            }

            .game-clock {
                padding: 8px 12px;
                background: rgba(26, 0, 51, 0.9);
                border: 2px solid rgba(138, 43, 226, 0.7);
                border-radius: 8px;
                color: #daa520;
                font-size: 14px;
                font-weight: bold;
                font-family: monospace;
            }

            /* Responsive design */
            @media (max-width: 1200px) {
                .player-legend {
                    width: 200px;
                    font-size: 10px;
                    padding: 10px;
                }
                
                .score-display {
                    min-width: 110px;
                    padding: 10px 14px;
                    font-size: 12px;
                }
                
                .treasure-tracker {
                    width: 130px;
                }
                
                .prime-radiant {
                    width: 100px;
                    height: 140px;
                }
            }

            @media (max-width: 900px) {
                .player-info {
                    gap: 15px;
                    margin-bottom: 10px;
                }
                
                .player-info.player2 {
                    margin-top: 10px;
                }
                
                .player-legend {
                    width: 160px;
                    font-size: 9px;
                    padding: 8px;
                }
                
                .character-ability {
                    padding: 6px;
                }
                
                .ability-name {
                    font-size: 9px;
                }
                
                .ability-description {
                    font-size: 7px;
                }
                
                .score-display {
                    min-width: 100px;
                    padding: 8px 12px;
                    font-size: 11px;
                }
                
                .treasure-tracker {
                    width: 110px;
                    padding: 8px;
                }
                
                .prime-radiant {
                    width: 90px;
                    height: 120px;
                }
                
                .hand {
                    max-width: 85vw;
                }
                
                .card {
                    width: 55px;
                    height: 85px;
                }
            }

            @media (max-width: 600px) {
                .player-info {
                    gap: 10px;
                    flex-direction: column;
                    align-items: center;
                }
                
                .player-legend {
                    width: 140px;
                    font-size: 8px;
                    padding: 6px;
                }
                
                .character-ability {
                    padding: 4px;
                    margin-bottom: 6px;
                }
                
                .ability-name {
                    font-size: 8px;
                }
                
                .ability-description {
                    font-size: 6px;
                }
                
                .score-display {
                    min-width: 90px;
                    padding: 6px 10px;
                    font-size: 10px;
                }
                
                .treasure-tracker {
                    width: 90px;
                    padding: 6px;
                    font-size: 9px;
                }
                
                .prime-radiant {
                    width: 80px;
                    height: 110px;
                }
                
                .card {
                    width: 45px;
                    height: 70px;
                }
                
                .hand {
                    gap: 8px;
                }
            }
        </style>
    </head>
    <body>
        <div id="gameContainer"></div>

        <script>
            // Game configuration
            const SUITS = {
                mental: { name: "Mental", symbol: "üß†", color: "#4169e1", graphicSymbol: "‚óÜ" },
                physical: { name: "Physical", symbol: "‚öîÔ∏è", color: "#ffd700", graphicSymbol: "‚ô¶" },
                temporal: { name: "Temporal", symbol: "‚è≥", color: "#dc143c", graphicSymbol: "‚ñ≤" },
            };

            const ABILITIES = {
                1: {
                    name: "Whispered Redirection",
                    description: "Lose trick, lead next",
                },
                3: {
                    name: "Mental Static",
                    description: "Exchange Prime Radiant",
                },
                5: { name: "Intuitive Leap", description: "Draw and discard" },
                7: { name: "Conversion Point", description: "Worth 1 point" },
                9: {
                    name: "Mentalic Resonance",
                    description: "Becomes dominant aspect",
                },
                11: {
                    name: "Speaker's Command",
                    description: "Force 1 or highest",
                },
            };

            // Foundation character names for players
            const FOUNDATION_CHARACTERS = [
                "Hari Seldon", "Wanda Seldon", "Preem Palver", "Bayta Darell", 
                "Arkady Darell", "Stor Gendibal", "Janov Pelorat", "Dors Venabili",
                "Golan Trevize", "Salvor Hardin", "Hober Mallow", "Limmar Ponyets",
                "Bel Riose", "Lathan Devers", "Magnifico Giganticus", "Han Pritcher",
                "Ebling Mis", "Yugo Amaryl", "Raych Seldon", "Bliss",
                "Daneel Olivaw", "Giskard Reventlov", "Klia Asgar", "Stettin Palver",
                "Jorane Sutt", "Eskel Gorov", "Randu", "Toran Darell"
            ];

            // Character abilities system - each character has a unique power
            const CHARACTER_ABILITIES = {
                "Hari Seldon": {
                    name: "Psychohistorical Calculation",
                    description: "Once per round, reveal top card of deck before playing",
                    icon: "üîÆ"
                },
                "Wanda Seldon": {
                    name: "Mental Shielding", 
                    description: "Opponent cannot use Speaker's Command (11) against you",
                    icon: "üõ°Ô∏è"
                },
                "Preem Palver": {
                    name: "First Speaker's Authority",
                    description: "When you win a 7, draw an extra card",
                    icon: "üëë"
                },
                "Bayta Darell": {
                    name: "Intuitive Resistance",
                    description: "May play any card when opponent plays 11",
                    icon: "üí´"
                },
                "Arkady Darell": {
                    name: "Second Foundation Legacy", 
                    description: "Start each round with one extra card, discard one",
                    icon: "üìö"
                },
                "Stor Gendibal": {
                    name: "Mental Static Master",
                    description: "When you play 3, you may exchange with opponent's hand instead",
                    icon: "‚ö°"
                },
                "Janov Pelorat": {
                    name: "Historical Knowledge",
                    description: "See one random card from opponent's hand at start of each trick",
                    icon: "üìñ"
                },
                "Dors Venabili": {
                    name: "Protective Instincts",
                    description: "First 7 you lose each round doesn't count toward opponent's score",
                    icon: "‚öîÔ∏è"
                },
                "Golan Trevize": {
                    name: "Decision Maker",
                    description: "May change trump suit once per round after seeing it",
                    icon: "üéØ"
                },
                "Salvor Hardin": {
                    name: "Political Acumen",
                    description: "Gain 1 extra point when winning with exactly 7-9 tricks",
                    icon: "üèõÔ∏è"
                },
                "Hober Mallow": {
                    name: "Trader's Insight", 
                    description: "Physical suit cards (‚öîÔ∏è) count as any suit for you",
                    icon: "üí∞"
                },
                "Limmar Ponyets": {
                    name: "Silver Tongue",
                    description: "When you lose a trick, peek at next Prime Radiant card",
                    icon: "üíé"
                },
                "Bel Riose": {
                    name: "Military Strategy",
                    description: "Your 1s act as if they were 11s for winning tricks",
                    icon: "üéñÔ∏è"
                },
                "Lathan Devers": {
                    name: "Merchant Prince",
                    description: "Draw 1 extra card when using Intuitive Leap (5)",
                    icon: "üë®‚Äçüíº"
                },
                "Magnifico Giganticus": {
                    name: "Emotional Manipulation",
                    description: "Opponent must show you their hand when they play a 9",
                    icon: "üé≠"
                },
                "Han Pritcher": {
                    name: "Imperial Agent",
                    description: "May convert one 7 you win into any suit for scoring",
                    icon: "üï¥Ô∏è"
                },
                "Ebling Mis": {
                    name: "Plan Analysis", 
                    description: "Once per game, redraw your entire hand",
                    icon: "üßÆ"
                },
                "Yugo Amaryl": {
                    name: "Mathematical Precision",
                    description: "Mentalic Resonance (9) always works, even with opponent's 9",
                    icon: "üî¢"
                },
                "Raych Seldon": {
                    name: "Street Smart",
                    description: "May discard and redraw when forced to play extreme cards",
                    icon: "üèÉ"
                },
                "Bliss": {
                    name: "Gaia Integration",
                    description: "Temporal suit (‚è≥) cards give +1 point when you win the trick",
                    icon: "üåç"
                },
                "Daneel Olivaw": {
                    name: "Robotic Logic",
                    description: "Never affected by any special abilities (except your own)",
                    icon: "ü§ñ"
                },
                "Giskard Reventlov": {
                    name: "Zeroth Law",
                    description: "May sacrifice 2 points to force opponent to redraw their hand",
                    icon: "‚öñÔ∏è"
                },
                "Klia Asgar": {
                    name: "Seldon Crisis Specialist",
                    description: "Double points when winning with exactly 0-3 or 7-9 tricks",
                    icon: "‚≠ê"
                },
                "Stettin Palver": {
                    name: "Trade Federation",
                    description: "Physical cards in your winning tricks are worth +1 point each",
                    icon: "üö¢"
                },
                "Jorane Sutt": {
                    name: "Political Maneuvering", 
                    description: "May force trump to change when you play Whispered Redirection (1)",
                    icon: "üé™"
                },
                "Eskel Gorov": {
                    name: "Encyclopedia Foundation",
                    description: "Start with knowledge of 3 random cards in opponent's hand",
                    icon: "üìö"
                },
                "Randu": {
                    name: "Resistance Leader",
                    description: "Immune to conversion - opponent gains no points from 7s you win",
                    icon: "‚úä"
                },
                "Toran Darell": {
                    name: "Foundation Loyalty", 
                    description: "Mental suit (üß†) cards cannot be taken by Mental Static (3)",
                    icon: "üß†"
                }
            };

            function getRandomCharacterNames() {
                const shuffled = [...FOUNDATION_CHARACTERS].sort(() => Math.random() - 0.5);
                return {
                    player1: shuffled[0],
                    player2: shuffled[1]
                };
            }

            // Game state
            let gameState = {
                started: false,
                gameMode: null, // 'pvp' or 'ai'
                currentPlayer: 1,
                viewingPlayer: 1,
                autoSwitch: true,
                
                // Character names and abilities
                player1Name: "Mentalic 1",
                player2Name: "Mentalic 2",
                player1Ability: null,
                player2Ability: null,
                
                // Character ability usage tracking
                player1AbilityUsed: false,
                player2AbilityUsed: false,
                
                // Cards played history for debugging
                playedCardsHistory: [],

                // Hands
                player1Hand: [],
                player2Hand: [],

                // Prime Radiant
                primeRadiant: null,
                dominantAspect: null,

                // Current trick
                currentTrick: [],
                trickNumber: 1,
                leadingAspect: null,

                // Scores
                player1Tricks: 0,
                player2Tricks: 0,
                player1RoundScore: 0,
                player2RoundScore: 0,
                player1TotalScore: 0,
                player2TotalScore: 0,

                // Deck
                deck: [],
                drawPile: [],

                // UI state
                player1Revealing: false,
                player2Revealing: false,

                // Special rules
                mustPlay: null,

                // Special ability states
                awaitingSelection: null, // For abilities that need user input
                selectedCard: null,

                // Treasure tracking (7s collected this round)
                treasuresThisRound: {
                    mental: null, // null, 1, or 2
                    physical: null,
                    temporal: null,
                },

                // Game timing
                startTime: null,
                clockInterval: null,
            };

            // Initialize game
            function initializeGame() {
                // Create deck
                gameState.deck = [];
                for (let suit in SUITS) {
                    for (let value = 1; value <= 11; value++) {
                        gameState.deck.push({ suit, value });
                    }
                }

                // Shuffle
                shuffleDeck();

                // Deal hands
                gameState.player1Hand = gameState.deck.splice(0, 13);
                gameState.player2Hand = gameState.deck.splice(0, 13);
                gameState.drawPile = [...gameState.deck];

                // Set Prime Radiant
                gameState.primeRadiant = gameState.drawPile.shift();
                gameState.dominantAspect = gameState.primeRadiant.suit;

                // Reset round state
                gameState.currentTrick = [];
                gameState.trickNumber = 1;
                gameState.playedCardsHistory = [];
                gameState.player1Tricks = 0;
                gameState.player2Tricks = 0;
                gameState.player1RoundScore = 0;
                gameState.player2RoundScore = 0;
                gameState.currentPlayer = 2; // Non-dealer leads
                gameState.awaitingSelection = null;

                // Reset treasure tracking
                gameState.treasuresThisRound = {
                    mental: null,
                    physical: null,
                    temporal: null,
                };

                renderGame();

                // If AI mode and AI's turn, make AI move
                if (
                    gameState.gameMode === "ai" &&
                    gameState.currentPlayer === 2
                ) {
                    setTimeout(() => makeAIMove(), 1000);
                }
            }

            // Shuffle deck
            function shuffleDeck() {
                for (let i = gameState.deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [gameState.deck[i], gameState.deck[j]] = [
                        gameState.deck[j],
                        gameState.deck[i],
                    ];
                }
            }

            // Create card HTML
            function createCardHTML(
                card,
                index,
                player,
                clickable = false,
                selectable = false,
            ) {
                if (!card) {
                    return `
                    <div class="card concealed">
                        <div class="card-face">
                            <div class="equations-overlay">
                                <div class="equation-line" style="top: 15px; animation-delay: ${Math.random() * 2}s;">
                                    ‚àÇŒ®/‚àÇt = -iƒ§Œ®/‚Ñè
                                </div>
                                <div class="equation-line" style="top: 35px; animation-delay: ${Math.random() * 2 + 1}s;">
                                    P(crisis|actions) = Œ£·µ¢ Œ±·µ¢¬∑œÜ·µ¢(t)
                                </div>
                                <div class="equation-line" style="top: 55px; animation-delay: ${Math.random() * 2 + 2}s;">
                                    ‚àá¬≤S = k¬≤¬∑exp(-iœât/c)
                                </div>
                                <div class="equation-line" style="top: 75px; animation-delay: ${Math.random() * 2 + 3}s;">
                                    lim[t‚Üí‚àû] P(Empire|Plan) = 1
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }

                // Show current player's cards, hide opponent's cards
                // But if no player is specified (like cards in play), always show them
                const concealed = player && player !== gameState.currentPlayer;

                const playable =
                    clickable &&
                    !concealed &&
                    canPlayCard(player, card) &&
                    !gameState.awaitingSelection;

                return `
                <div class="card ${card.suit} ${concealed ? "concealed" : ""} ${playable ? "playable" : ""} ${selectable ? "selectable" : ""}"
                     ${clickable && playable ? `onclick="playCard(${player}, ${index})"` : ""}
                     ${selectable ? `onclick="selectCard(${index})"` : ""}>
                    <div class="card-face">
                        <div class="card-content">
                            <div class="card-value">${card.value}</div>
                            <div class="card-suit">${SUITS[card.suit].symbol}</div>
                            ${ABILITIES[card.value] ? `<div class="ability-name">${ABILITIES[card.value].name}</div>` : ""}
                        </div>
                        ${
                            concealed
                                ? `
                            <div class="equations-overlay">
                                <div class="equation-line" style="top: 15px; animation-delay: ${Math.random() * 3}s;">
                                    ‚àÇŒ®/‚àÇt = -iƒ§Œ®/‚Ñè
                                </div>
                                <div class="equation-line" style="top: 35px; animation-delay: ${Math.random() * 3 + 1}s;">
                                    P(crisis|actions) = Œ£·µ¢ Œ±·µ¢¬∑œÜ·µ¢(t)
                                </div>
                                <div class="equation-line" style="top: 55px; animation-delay: ${Math.random() * 3 + 2}s;">
                                    ‚àá¬≤S = k¬≤¬∑exp(-iœât/c)
                                </div>
                                <div class="equation-line" style="top: 75px; animation-delay: ${Math.random() * 3 + 3}s;">
                                    lim[t‚Üí‚àû] P(Empire|Plan) = 1
                                </div>
                            </div>
                        `
                                : ""
                        }
                    </div>
                </div>
            `;
            }

            // Check if card can be played
            function canPlayCard(player, card) {
                if (player !== gameState.currentPlayer) return false;
                if (gameState.currentTrick.length === 0) return true;

                const hand =
                    player === 1
                        ? gameState.player1Hand
                        : gameState.player2Hand;
                const leadSuit = gameState.leadingAspect;
                const hasSuit = hand.some((c) => c.suit === leadSuit);

                if (gameState.mustPlay === "extreme") {
                    const suitCards = hand.filter((c) => c.suit === leadSuit);
                    if (suitCards.length === 0) return true;
                    const maxValue = Math.max(...suitCards.map((c) => c.value));
                    return (
                        (card.value === 1 || card.value === maxValue) &&
                        card.suit === leadSuit
                    );
                }

                return !hasSuit || card.suit === leadSuit;
            }

            // Play a card
            function playCard(player, cardIndex) {
                if (gameState.awaitingSelection) return;

                if (player !== gameState.currentPlayer) {
                    alert(`It's Player ${gameState.currentPlayer}'s turn!`);
                    return;
                }

                const hand =
                    player === 1
                        ? gameState.player1Hand
                        : gameState.player2Hand;
                const card = hand[cardIndex];

                if (!canPlayCard(player, card)) {
                    alert("You must follow suit if possible!");
                    return;
                }

                // Remove from hand and add to trick
                hand.splice(cardIndex, 1);
                gameState.currentTrick.push({ ...card, player });
                
                // Add to played cards history
                gameState.playedCardsHistory.push({
                    player: player,
                    card: card,
                    trick: gameState.trickNumber
                });

                // Set leading aspect
                if (gameState.currentTrick.length === 1) {
                    gameState.leadingAspect = card.suit;

                    if (card.value === 11) {
                        gameState.mustPlay = "extreme";
                    }
                } else {
                    gameState.mustPlay = null;
                }

                // Process special abilities
                if (card.value === 5 && gameState.drawPile.length > 0) {
                    // Intuitive Leap - draw a card and select discard
                    hand.push(gameState.drawPile.shift());
                    gameState.awaitingSelection = { type: "discard", player };
                    renderGame();
                    return;
                }

                if (card.value === 3) {
                    // Mental Static - select card to exchange with Prime Radiant
                    gameState.awaitingSelection = { type: "exchange", player };
                    renderGame();
                    return;
                }

                // Check if trick is complete
                if (gameState.currentTrick.length === 2) {
                    setTimeout(() => resolveTrick(), 1500);
                } else {
                    gameState.currentPlayer = player === 1 ? 2 : 1;

                    // Auto-switch view if enabled and in PvP mode
                    if (gameState.gameMode === "pvp" && gameState.autoSwitch) {
                        gameState.viewingPlayer = gameState.currentPlayer;
                    }

                    // Make AI move if it's AI's turn
                    if (
                        gameState.gameMode === "ai" &&
                        gameState.currentPlayer === 2
                    ) {
                        setTimeout(() => makeAIMove(), 1000);
                    }
                }

                renderGame();
            }

            // Handle card selection for special abilities
            function selectCard(index) {
                if (!gameState.awaitingSelection) return;

                const player = gameState.awaitingSelection.player;
                const hand =
                    player === 1
                        ? gameState.player1Hand
                        : gameState.player2Hand;

                if (gameState.awaitingSelection.type === "exchange") {
                    // Exchange with Prime Radiant
                    const temp = gameState.primeRadiant;
                    gameState.primeRadiant = hand[index];
                    hand[index] = temp;
                    gameState.dominantAspect = gameState.primeRadiant.suit;
                } else if (gameState.awaitingSelection.type === "discard") {
                    // Discard to bottom of deck
                    const discarded = hand.splice(index, 1)[0];
                    gameState.drawPile.push(discarded);
                }

                gameState.awaitingSelection = null;

                // Continue with turn
                if (gameState.currentTrick.length === 2) {
                    setTimeout(() => resolveTrick(), 1500);
                } else {
                    gameState.currentPlayer = player === 1 ? 2 : 1;

                    // Auto-switch view if enabled
                    if (gameState.gameMode === "pvp" && gameState.autoSwitch) {
                        gameState.viewingPlayer = gameState.currentPlayer;
                    }

                    // Make AI move if it's AI's turn
                    if (
                        gameState.gameMode === "ai" &&
                        gameState.currentPlayer === 2
                    ) {
                        setTimeout(() => makeAIMove(), 1000);
                    }
                }

                renderGame();
            }

            // AI Logic
            function makeAIMove() {
                if (gameState.currentPlayer !== 2) return;

                const hand = gameState.player2Hand;
                let validCards = [];

                // Find all valid plays
                for (let i = 0; i < hand.length; i++) {
                    if (canPlayCard(2, hand[i])) {
                        validCards.push({ card: hand[i], index: i });
                    }
                }

                if (validCards.length === 0) return;

                // AI Strategy
                let chosenCard;

                if (gameState.currentTrick.length === 0) {
                    // Leading - AI strategy
                    const tricks = gameState.player2Tricks;

                    if (tricks <= 2) {
                        // Try to lose tricks early - play high cards
                        validCards.sort((a, b) => b.card.value - a.card.value);
                    } else if (tricks >= 7) {
                        // Try to lose tricks if getting close to 10 - play high cards
                        validCards.sort((a, b) => b.card.value - a.card.value);
                    } else {
                        // Middle game - try to win with low cards
                        validCards.sort((a, b) => a.card.value - b.card.value);
                    }
                    chosenCard = validCards[0];
                } else {
                    // Following - calculate if we can/should win
                    const leadCard = gameState.currentTrick[0];
                    const canWin = validCards.some(
                        (v) =>
                            (v.card.suit === gameState.dominantAspect &&
                                leadCard.suit !== gameState.dominantAspect) ||
                            (v.card.suit === leadCard.suit &&
                                v.card.value > leadCard.value),
                    );

                    const tricks = gameState.player2Tricks;
                    const shouldTryToWin = tricks >= 3 && tricks <= 6;

                    if (canWin && shouldTryToWin) {
                        // Try to win with lowest winning card
                        const winningCards = validCards.filter(
                            (v) =>
                                (v.card.suit === gameState.dominantAspect &&
                                    leadCard.suit !==
                                        gameState.dominantAspect) ||
                                (v.card.suit === leadCard.suit &&
                                    v.card.value > leadCard.value),
                        );
                        winningCards.sort(
                            (a, b) => a.card.value - b.card.value,
                        );
                        chosenCard = winningCards[0];
                    } else {
                        // Try to lose with highest card
                        validCards.sort((a, b) => b.card.value - a.card.value);
                        chosenCard = validCards[0];
                    }
                }

                // Show AI thinking indicator
                renderGame(true);

                setTimeout(() => {
                    // Play the chosen card
                    const hand = gameState.player2Hand;
                    const card = hand[chosenCard.index];

                    hand.splice(chosenCard.index, 1);
                    gameState.currentTrick.push({ ...card, player: 2 });
                    
                    // Add to played cards history
                    gameState.playedCardsHistory.push({
                        player: 2,
                        card: card,
                        trick: gameState.trickNumber
                    });

                    // Set leading aspect
                    if (gameState.currentTrick.length === 1) {
                        gameState.leadingAspect = card.suit;
                        if (card.value === 11) {
                            gameState.mustPlay = "extreme";
                        }
                    } else {
                        gameState.mustPlay = null;
                    }

                    // Handle special abilities for AI
                    if (card.value === 5 && gameState.drawPile.length > 0) {
                        // AI draws and discards highest card
                        hand.push(gameState.drawPile.shift());
                        hand.sort((a, b) => b.value - a.value);
                        const discarded = hand.shift();
                        gameState.drawPile.push(discarded);
                    }

                    if (card.value === 3) {
                        // AI exchanges lowest non-trump card
                        const nonTrump = hand.filter(
                            (c) => c.suit !== gameState.dominantAspect,
                        );
                        if (nonTrump.length > 0) {
                            nonTrump.sort((a, b) => a.value - b.value);
                            const idx = hand.indexOf(nonTrump[0]);
                            const temp = gameState.primeRadiant;
                            gameState.primeRadiant = hand[idx];
                            hand[idx] = temp;
                            gameState.dominantAspect =
                                gameState.primeRadiant.suit;
                        }
                    }

                    // Check if trick is complete
                    if (gameState.currentTrick.length === 2) {
                        setTimeout(() => resolveTrick(), 1500);
                    } else {
                        gameState.currentPlayer = 1;
                        if (gameState.autoSwitch) {
                            gameState.viewingPlayer = 1;
                        }
                    }

                    renderGame();
                }, 1500);
            }

            // Resolve trick
            function resolveTrick() {
                const trick = gameState.currentTrick;
                let winner;

                // Check for 9 ability
                const has9 = trick.filter((c) => c.value === 9);
                if (has9.length === 1) {
                    has9[0].tempTrump = true;
                }

                // Determine winner
                const trumpCards = trick.filter(
                    (c) => c.suit === gameState.dominantAspect || c.tempTrump,
                );
                if (trumpCards.length > 0) {
                    winner = trumpCards.reduce((a, b) =>
                        a.value > b.value ? a : b,
                    );
                } else {
                    const leadCards = trick.filter(
                        (c) => c.suit === gameState.leadingAspect,
                    );
                    winner = leadCards.reduce((a, b) =>
                        a.value > b.value ? a : b,
                    );
                }

                // Check for 1 ability
                const has1 = trick.filter((c) => c.value === 1);
                let nextLead = winner.player;
                if (has1.length === 1 && has1[0].player !== winner.player) {
                    nextLead = has1[0].player;
                }

                // Award trick
                if (winner.player === 1) {
                    gameState.player1Tricks++;
                } else {
                    gameState.player2Tricks++;
                }

                // Check for 7 points and track treasures
                trick.forEach((card) => {
                    if (card.value === 7) {
                        // Track which player collected this 7
                        gameState.treasuresThisRound[card.suit] = winner.player;
                        
                        // Immediately update influence score
                        if (winner.player === 1) {
                            gameState.player1RoundScore++;
                            gameState.player1TotalScore++;
                        } else {
                            gameState.player2RoundScore++;
                            gameState.player2TotalScore++;
                        }
                    }
                });

                // Clear trick
                gameState.currentTrick = [];
                gameState.leadingAspect = null;

                // Check if round is complete
                if (gameState.trickNumber === 13) {
                    endRound();
                } else {
                    gameState.trickNumber++;
                    gameState.currentPlayer = nextLead;

                    // Auto-switch view if enabled
                    if (gameState.gameMode === "pvp" && gameState.autoSwitch) {
                        gameState.viewingPlayer = gameState.currentPlayer;
                    }

                    // Make AI move if it's AI's turn
                    if (
                        gameState.gameMode === "ai" &&
                        gameState.currentPlayer === 2
                    ) {
                        setTimeout(() => makeAIMove(), 1000);
                    }

                    renderGame();
                }
            }

            // End round
            function endRound() {
                const calculateScore = (tricks) => {
                    if (tricks <= 3) return 6;
                    if (tricks === 4) return 1;
                    if (tricks === 5) return 2;
                    if (tricks === 6) return 3;
                    if (tricks <= 9) return 6;
                    return 0;
                };

                // Only add trick-based scoring (7s already added immediately during play)
                gameState.player1TotalScore += calculateScore(gameState.player1Tricks);
                gameState.player2TotalScore += calculateScore(gameState.player2Tricks);

                if (
                    gameState.player1TotalScore >= 21 ||
                    gameState.player2TotalScore >= 21
                ) {
                    endGame();
                } else {
                    setTimeout(() => {
                        alert(
                            `Round Complete!\n\n${gameState.player1Name}: ${gameState.player1Tricks} nodes\n${gameState.player2Name}: ${gameState.player2Tricks} nodes\n\nTotal Influence:\n${gameState.player1Name}: ${gameState.player1TotalScore}\n${gameState.player2Name}: ${gameState.player2TotalScore}`,
                        );
                        initializeGame();
                    }, 1000);
                }
            }

            // End game
            function endGame() {
                const winner =
                    gameState.player1TotalScore > gameState.player2TotalScore
                        ? 1
                        : 2;
                document.getElementById("gameContainer").innerHTML = `
                <div class="victory-screen">
                    <h2>Calculation Complete</h2>
                    <div class="final-scores">
                        <p>The Prime Radiant accepts ${winner === 1 ? gameState.player1Name : gameState.player2Name}'s path</p>
                        <br />
                        <p>${gameState.player1Name} Influence: ${gameState.player1TotalScore}</p>
                        <p>${gameState.player2Name} Influence: ${gameState.player2TotalScore}</p>
                        <br />
                        <p>"The Second Empire shall rise through careful calculation"</p>
                    </div>
                    <button class="new-game-btn" onclick="startNewGame()">
                        New Calculation
                    </button>
                </div>
            `;
            }

            // Start new game
            function startNewGame() {
                gameState.player1TotalScore = 0;
                gameState.player2TotalScore = 0;
                gameState.started = false;
                gameState.gameMode = null;
                renderGame();
            }

            // Start game with mode
            function startGame(mode) {
                gameState.started = true;
                gameState.gameMode = mode;
                gameState.viewingPlayer = 1;
                gameState.startTime = Date.now();
                
                // Assign random Foundation character names and abilities
                const names = getRandomCharacterNames();
                gameState.player1Name = names.player1;
                gameState.player2Name = mode === 'ai' ? names.player2 + " (AI)" : names.player2;
                gameState.player1Ability = CHARACTER_ABILITIES[names.player1];
                gameState.player2Ability = CHARACTER_ABILITIES[names.player2];
                
                // Start game clock
                if (gameState.clockInterval) {
                    clearInterval(gameState.clockInterval);
                }
                gameState.clockInterval = setInterval(updateClock, 1000);
                
                initializeGame();
            }

            // Restart game
            function restartGame() {
                if (confirm("Are you sure you want to restart the game?")) {
                    // Stop clock
                    if (gameState.clockInterval) {
                        clearInterval(gameState.clockInterval);
                    }
                    
                    // Reset all game state
                    gameState.started = false;
                    gameState.gameMode = null;
                    gameState.player1TotalScore = 0;
                    gameState.player2TotalScore = 0;
                    gameState.startTime = null;
                    gameState.clockInterval = null;
                    
                    renderGame();
                }
            }

            // Update game clock
            function updateClock() {
                renderGame();
            }

            // Format elapsed time
            function formatTime(milliseconds) {
                const totalSeconds = Math.floor(milliseconds / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            // Toggle reveal
            function toggleReveal(player, state) {
                if (gameState.gameMode === "ai" && player === 2) return;

                // Allow revealing for both players regardless of viewing player
                if (player === 1) {
                    gameState.player1Revealing = state;
                } else if (player === 2) {
                    gameState.player2Revealing = state;
                }
                renderGame();
            }

            // Toggle auto-switch
            function toggleAutoSwitch() {
                gameState.autoSwitch = !gameState.autoSwitch;
                renderGame();
            }

            // Generate cards played history display
            function generateHistoryDisplay() {
                if (gameState.playedCardsHistory.length === 0) {
                    return '<div style="color: #666; font-style: italic;">No cards played yet</div>';
                }

                // Group by trick and show recent history (last 10 entries)
                const recentHistory = gameState.playedCardsHistory.slice(-10);
                let html = '';
                let currentTrick = -1;

                for (const entry of recentHistory) {
                    if (entry.trick !== currentTrick) {
                        currentTrick = entry.trick;
                        html += `<div class="history-trick">--- Trick ${entry.trick} ---</div>`;
                    }
                    
                    // Simple ASCII representation: P1/P2 + suit symbol + value
                    const suitSymbol = SUITS[entry.card.suit].symbol;
                    const playerLabel = entry.player === 1 ? 'P1' : 'P2';
                    html += `<div class="history-entry">${playerLabel}: ${suitSymbol}${entry.card.value}</div>`;
                }

                return html;
            }

            // Render game
            function renderGame(showAIThinking = false) {
                const container = document.getElementById("gameContainer");

                if (!gameState.started) {
                    container.innerHTML = `
                    <div class="start-screen">
                        <h1>Whispers of Foundation</h1>
                        <div class="subtitle">A Second Foundation Duel</div>
                        <div class="description">
                            "From the shadows, we shape the light"<br /><br />
                            You are rival Second Foundation mentalics, manipulating the Prime Radiant.<br />
                            Each calculation shapes humanity's future. Subtle influence wins.<br />
                            Too much force reveals your hand and voids your equations.<br /><br />
                            <strong>Hold your reveal button to pierce your opponent's mental shield.</strong>
                        </div>
                        <div class="game-mode-buttons">
                            <button class="mode-btn" onclick="startGame('pvp')">
                                Two Players
                            </button>
                            <button class="mode-btn" onclick="startGame('ai')">
                                vs AI Mentalic
                            </button>
                        </div>
                    </div>
                `;
                    return;
                }

                const isPlayer1View = gameState.viewingPlayer === 1;

                // Selection modal
                let selectionModal = "";
                if (gameState.awaitingSelection) {
                    const player = gameState.awaitingSelection.player;
                    const hand =
                        player === 1
                            ? gameState.player1Hand
                            : gameState.player2Hand;

                    if (gameState.awaitingSelection.type === "exchange") {
                        selectionModal = `
                        <div class="selection-modal">
                            <h3>Mental Static - Exchange with Prime Radiant</h3>
                            <div class="instruction">Select a card from your hand to exchange</div>
                            <div class="selection-cards">
                                ${hand.map((card, idx) => createCardHTML(card, idx, player, false, true)).join("")}
                            </div>
                        </div>
                    `;
                    } else if (gameState.awaitingSelection.type === "discard") {
                        selectionModal = `
                        <div class="selection-modal">
                            <h3>Intuitive Leap - Discard a Card</h3>
                            <div class="instruction">Select a card to discard to the bottom of the deck</div>
                            <div class="selection-cards">
                                ${hand.map((card, idx) => createCardHTML(card, idx, player, false, true)).join("")}
                            </div>
                        </div>
                    `;
                    }
                }

                // AI thinking indicator
                let aiThinking = "";
                if (showAIThinking) {
                    aiThinking =
                        '<div class="ai-thinking">AI Mentalic calculating...</div>';
                }

                container.innerHTML = `
                <div class="game-container">
                    <!-- Game Controls -->
                    <div class="game-controls">
                        <div class="game-clock">
                            ${gameState.startTime ? formatTime(Date.now() - gameState.startTime) : "00:00"}
                        </div>
                        <button class="control-btn" onclick="restartGame()">
                            Restart
                        </button>
                        ${
                            gameState.gameMode === "pvp"
                                ? `
                            <button class="control-btn" onclick="toggleAutoSwitch()">
                                Auto: ${gameState.autoSwitch ? "ON" : "OFF"}
                            </button>
                        `
                                : ""
                        }
                    </div>

                    <div class="info-panel">
                        <h3>Node ${gameState.trickNumber} of 13</h3>
                        <div class="details">
                            Interpreting: ${gameState.currentPlayer === 1 ? gameState.player1Name : gameState.player2Name}
                            ${gameState.mustPlay ? " | Imperial Decree Active" : ""}
                        </div>
                    </div>




                    <!-- PLAYER 2 at top (opponent orientation) -->
                    <div class="player-area opponent">
                        <div class="hand ${gameState.player2Revealing ? "revealing" : ""}">
                            ${gameState.player2Hand
                                .map((card, idx) =>
                                    createCardHTML(
                                        card,
                                        idx,
                                        2,
                                        gameState.currentPlayer === 2 &&
                                            !gameState.awaitingSelection,
                                    ),
                                )
                                .join("")}
                        </div>
                        <div class="player-info player2">
                            <div class="player-legend">
                                <div class="legend-title">${gameState.player2Name.toUpperCase()}</div>
                                ${gameState.player2Ability ? `
                                    <div class="character-ability">
                                        <div class="ability-header">
                                            <span class="ability-icon">${gameState.player2Ability.icon}</span>
                                            <span class="ability-name">${gameState.player2Ability.name}</span>
                                        </div>
                                        <div class="ability-description">${gameState.player2Ability.description}</div>
                                    </div>
                                ` : ''}
                                <div class="abilities-grid">
                                    <div class="ability-item">
                                        <div class="ability-num special-1">1</div>
                                        <div class="ability-text">Lead next</div>
                                    </div>
                                    <div class="ability-item">
                                        <div class="ability-num special-3">3</div>
                                        <div class="ability-text">Exchange</div>
                                    </div>
                                    <div class="ability-item">
                                        <div class="ability-num special-5">5</div>
                                        <div class="ability-text">Draw/Discard</div>
                                    </div>
                                    <div class="ability-item">
                                        <div class="ability-num special-7">7</div>
                                        <div class="ability-text">+1 Point</div>
                                    </div>
                                    <div class="ability-item">
                                        <div class="ability-num special-9">9</div>
                                        <div class="ability-text">Dominant</div>
                                    </div>
                                    <div class="ability-item">
                                        <div class="ability-num special-11">11</div>
                                        <div class="ability-text">Force 1/Max</div>
                                    </div>
                                </div>
                                <div class="scoring-guide">
                                    <div class="score-zone current-${gameState.player2Tricks}">
                                        <span class="tricks-range">0-3:</span>
                                        <span class="points-award" style="color: #4169e1;">6</span>
                                    </div>
                                    <div class="score-zone current-${gameState.player2Tricks}">
                                        <span class="tricks-range">4:</span>
                                        <span class="points-award" style="color: #9b7dff;">1</span>
                                    </div>
                                    <div class="score-zone current-${gameState.player2Tricks}">
                                        <span class="tricks-range">5:</span>
                                        <span class="points-award" style="color: #9b7dff;">2</span>
                                    </div>
                                    <div class="score-zone current-${gameState.player2Tricks}">
                                        <span class="tricks-range">6:</span>
                                        <span class="points-award" style="color: #9b7dff;">3</span>
                                    </div>
                                    <div class="score-zone current-${gameState.player2Tricks}">
                                        <span class="tricks-range">7-9:</span>
                                        <span class="points-award" style="color: #4169e1;">6</span>
                                    </div>
                                    <div class="score-zone current-${gameState.player2Tricks}">
                                        <span class="tricks-range">10+:</span>
                                        <span class="points-award" style="color: #dc143c;">0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="score-display">
                                <h4>${gameState.player2Name}</h4>
                                <div class="score-line">
                                    <span>Influence:</span>
                                    <span>${gameState.player2TotalScore}</span>
                                </div>
                                <div class="score-line">
                                    <span>Nodes:</span>
                                    <span>${gameState.player2Tricks}</span>
                                </div>
                            </div>
                            <div class="treasure-tracker">
                                <h4>7's Won</h4>
                                <div class="treasure-suit">
                                    <div class="suit-info">
                                        <span class="suit-symbol">${SUITS.mental.symbol}</span>
                                    </div>
                                    <div class="treasure-indicator ${gameState.treasuresThisRound.mental === 2 ? 'player2' : ''}"></div>
                                </div>
                                <div class="treasure-suit">
                                    <div class="suit-info">
                                        <span class="suit-symbol">${SUITS.physical.symbol}</span>
                                    </div>
                                    <div class="treasure-indicator ${gameState.treasuresThisRound.physical === 2 ? 'player2' : ''}"></div>
                                </div>
                                <div class="treasure-suit">
                                    <div class="suit-info">
                                        <span class="suit-symbol">${SUITS.temporal.symbol}</span>
                                    </div>
                                    <div class="treasure-indicator ${gameState.treasuresThisRound.temporal === 2 ? 'player2' : ''}"></div>
                                </div>
                            </div>
                            <div class="prime-radiant-board">
                                <div class="label">PRIME RADIANT</div>
                                ${gameState.primeRadiant ? createCardHTML(gameState.primeRadiant) : ""}
                                <div class="dominant-aspect">
                                    <span class="aspect-symbol">${gameState.dominantAspect ? SUITS[gameState.dominantAspect].symbol : ""}</span>
                                    ${gameState.dominantAspect ? SUITS[gameState.dominantAspect].name : ""}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="play-field">
                        ${gameState.currentTrick.map((card) => createCardHTML(card)).join("")}
                    </div>

                    <!-- PLAYER 1 at bottom (normal orientation) -->
                    <div class="player-area">
                        <div class="player-info">
                            <div class="player-legend">
                                <div class="legend-title">${gameState.player1Name.toUpperCase()}</div>
                                ${gameState.player1Ability ? `
                                    <div class="character-ability">
                                        <div class="ability-header">
                                            <span class="ability-icon">${gameState.player1Ability.icon}</span>
                                            <span class="ability-name">${gameState.player1Ability.name}</span>
                                        </div>
                                        <div class="ability-description">${gameState.player1Ability.description}</div>
                                    </div>
                                ` : ''}
                                <div class="abilities-grid">
                                    <div class="ability-item">
                                        <div class="ability-num special-1">1</div>
                                        <div class="ability-text">Lead next</div>
                                    </div>
                                    <div class="ability-item">
                                        <div class="ability-num special-3">3</div>
                                        <div class="ability-text">Exchange</div>
                                    </div>
                                    <div class="ability-item">
                                        <div class="ability-num special-5">5</div>
                                        <div class="ability-text">Draw/Discard</div>
                                    </div>
                                    <div class="ability-item">
                                        <div class="ability-num special-7">7</div>
                                        <div class="ability-text">+1 Point</div>
                                    </div>
                                    <div class="ability-item">
                                        <div class="ability-num special-9">9</div>
                                        <div class="ability-text">Dominant</div>
                                    </div>
                                    <div class="ability-item">
                                        <div class="ability-num special-11">11</div>
                                        <div class="ability-text">Force 1/Max</div>
                                    </div>
                                </div>
                                <div class="scoring-guide">
                                    <div class="score-zone current-${gameState.player1Tricks}">
                                        <span class="tricks-range">0-3:</span>
                                        <span class="points-award" style="color: #4169e1;">6</span>
                                    </div>
                                    <div class="score-zone current-${gameState.player1Tricks}">
                                        <span class="tricks-range">4:</span>
                                        <span class="points-award" style="color: #9b7dff;">1</span>
                                    </div>
                                    <div class="score-zone current-${gameState.player1Tricks}">
                                        <span class="tricks-range">5:</span>
                                        <span class="points-award" style="color: #9b7dff;">2</span>
                                    </div>
                                    <div class="score-zone current-${gameState.player1Tricks}">
                                        <span class="tricks-range">6:</span>
                                        <span class="points-award" style="color: #9b7dff;">3</span>
                                    </div>
                                    <div class="score-zone current-${gameState.player1Tricks}">
                                        <span class="tricks-range">7-9:</span>
                                        <span class="points-award" style="color: #4169e1;">6</span>
                                    </div>
                                    <div class="score-zone current-${gameState.player1Tricks}">
                                        <span class="tricks-range">10+:</span>
                                        <span class="points-award" style="color: #dc143c;">0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="score-display">
                                <h4>${gameState.player1Name}</h4>
                                <div class="score-line">
                                    <span>Influence:</span>
                                    <span>${gameState.player1TotalScore}</span>
                                </div>
                                <div class="score-line">
                                    <span>Nodes:</span>
                                    <span>${gameState.player1Tricks}</span>
                                </div>
                            </div>
                            <div class="treasure-tracker">
                                <h4>7's Won</h4>
                                <div class="treasure-suit">
                                    <div class="suit-info">
                                        <span class="suit-symbol">${SUITS.mental.symbol}</span>
                                    </div>
                                    <div class="treasure-indicator ${gameState.treasuresThisRound.mental === 1 ? 'player1' : ''}"></div>
                                </div>
                                <div class="treasure-suit">
                                    <div class="suit-info">
                                        <span class="suit-symbol">${SUITS.physical.symbol}</span>
                                    </div>
                                    <div class="treasure-indicator ${gameState.treasuresThisRound.physical === 1 ? 'player1' : ''}"></div>
                                </div>
                                <div class="treasure-suit">
                                    <div class="suit-info">
                                        <span class="suit-symbol">${SUITS.temporal.symbol}</span>
                                    </div>
                                    <div class="treasure-indicator ${gameState.treasuresThisRound.temporal === 1 ? 'player1' : ''}"></div>
                                </div>
                            </div>
                            <div class="prime-radiant-board">
                                <div class="label">PRIME RADIANT</div>
                                ${gameState.primeRadiant ? createCardHTML(gameState.primeRadiant) : ""}
                                <div class="dominant-aspect">
                                    <span class="aspect-symbol">${gameState.dominantAspect ? SUITS[gameState.dominantAspect].symbol : ""}</span>
                                    ${gameState.dominantAspect ? SUITS[gameState.dominantAspect].name : ""}
                                </div>
                            </div>
                        </div>
                        <div class="hand ${gameState.player1Revealing ? "revealing" : ""}">
                            ${gameState.player1Hand
                                .map((card, idx) =>
                                    createCardHTML(
                                        card,
                                        idx,
                                        1,
                                        gameState.currentPlayer === 1 &&
                                            !gameState.awaitingSelection,
                                    ),
                                )
                                .join("")}
                        </div>
                    </div>

                    ${selectionModal}
                    ${aiThinking}
                    
                    <!-- Cards Played History -->
                    <div class="cards-history">
                        <h4>Cards Played</h4>
                        ${generateHistoryDisplay()}
                    </div>
                </div>
            `;
            }

            // Initial render
            renderGame();
        </script>
    </body>
</html>
